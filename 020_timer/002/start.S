.text
.global _start

_start:
	b reset	/* vector 0: reset */
	/* å¦‚æœä¸‹é¢å¤„ç†å‡½æ•°æ˜¯è¶…è¿‡4k(nandå¯åŠ¨)çš„ï¼Œé‚£ä¹ˆå¿…å®šå‡ºé”™ */
	//b do_und	/* vectro 4:und */
	
	/* éœ€è¦è·³è½¬åˆ°sdramä¸­å»,ä½†æ˜¯å¦‚æœstart.Så¾ˆå¤§ï¼Œè¶…è¿‡äº†å‰é¢4kï¼Œé‚£è¿™é‡Œä¹Ÿä¼šæœ‰é—®é¢˜ */
	//ldr pc, = do_und

	/* è¿™ä¹ˆå¤„ç†ä¹‹åï¼Œå°±æ˜¯ä¸ç®¡start.Så¤šå¤§ï¼Œéƒ½ä¼šåœ¨4ké‡Œé¢äº† */
	ldr pc, und_addr  /* vectro 4:und */
	ldr pc, swi_addr  /* vectro 8:swi */
	b halt			  /* 0x0c=>abort(prefetch) */
	b halt			  /* 0x10=>abort(data) */
	b halt			  /* 0x14=>reserved */
	ldr pc, irq_addr  /* 0x18=>IRQ */
	b halt			  /* 0x1c=>FIQ */

	/* è¿™é‡Œå¤„ç†ä¹‹å */
und_addr:
	.word do_und

swi_addr:
	.word do_swi

irq_addr:
	.word do_irq

do_und:
	/* 
	* æ‰§è¡Œåˆ°è¿™é‡Œä¹‹å‰ï¼š
	* 1.lr_und ä¿å­˜æœ‰è¢«ä¸­æ–­æ¨¡å¼ä¸‹çš„ä¸‹ä¸€æ¡å³å°†æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€
	* 2.SPSR_und ä¿å­˜æœ‰è¢«ä¸­æ–­æ¨¡å¼çš„CPSR
	* 3.CPSRä¸­çš„M4-M0è¢«è®¾ç½®ä½11011b,è¿›å…¥åˆ°undæ¨¡å¼
	* 4.è·³åˆ°0x4çš„åœ°æ–¹æ‰§è¡Œç¨‹åº
	*/

	/* sp undæœªè®¾ç½®ï¼Œå…ˆè®¾ç½®å®ƒ */
	ldr sp, = 0x34000000

	/*
	* lræ˜¯å¼‚å¸¸å¤„ç†å®Œåçš„è¿”å›åœ°å€ï¼Œä¹Ÿè¦ä¿å­˜
	*/
	stmdb sp!, {r0-r12, lr}	/* åœ¨undå¼‚å¸¸å¤„ç†å‡½æ•°ä¸­æœ‰å¯èƒ½ä¼šä¿®æ”¹r0-r12ï¼Œæ‰€ä»¥å…ˆä¿å­˜ä¸‹æ¥ */
	
	/* ä¿å­˜ç°åœº */	
	/* å¤„ç†undå¼‚å¸¸ */
	mrs r0, cpsr
	ldr r1, = und_string
	bl printException
	
	/* æ¢å¤ç°åœº */
	ldmia sp!, {r0-r12, pc}^	/*å°–æ‹¬å·ä¼šæŠŠspsrçš„å€¼æ¢å¤åˆ°cpsrä¸­*/ 
	
und_string:
	.string "undefined instruction exception"

.align 4

do_irq:
	/* 
	* æ‰§è¡Œåˆ°è¿™é‡Œä¹‹å‰ï¼š
	* 1.lr_irq ä¿å­˜æœ‰è¢«ä¸­æ–­æ¨¡å¼ä¸‹çš„ä¸‹ä¸€æ¡å³å°†æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€
	* 2.SPSR_irq ä¿å­˜æœ‰è¢«ä¸­æ–­æ¨¡å¼çš„CPSR
	* 3.CPSRä¸­çš„M4-M0è¢«è®¾ç½®ä½10010b,è¿›å…¥åˆ°irqæ¨¡å¼
	* 4.è·³åˆ°0x18çš„åœ°æ–¹æ‰§è¡Œç¨‹åº
	*/

	/* sp irqæœªè®¾ç½®ï¼Œå…ˆè®¾ç½®å®ƒ */
	ldr sp, = 0x33d00000

	/*
	* lr-4æ˜¯å¼‚å¸¸å¤„ç†å®Œåçš„è¿”å›åœ°å€ï¼Œä¹Ÿè¦ä¿å­˜
	*/
	sub lr, lr, #4
	stmdb sp!, {r0-r12, lr}	/* åœ¨irqå¼‚å¸¸å¤„ç†å‡½æ•°ä¸­æœ‰å¯èƒ½ä¼šä¿®æ”¹r0-r12ï¼Œæ‰€ä»¥å…ˆä¿å­˜ä¸‹æ¥ */
	
	/* ä¿å­˜ç°åœº */	
	/* å¤„ç†irqå¼‚å¸¸,ä¸è¿›è¡Œæ‰“å°ï¼Œæ‰§è¡ŒæŸä¸ªCå‡½æ•° */
	bl handle_irq_c
	
	/* æ¢å¤ç°åœº */
	ldmia sp!, {r0-r12, pc}^	/*å°–æ‹¬å·ä¼šæŠŠspsr_irqçš„å€¼æ¢å¤åˆ°cpsrä¸­*/ 
	
do_swi:
	/* 
	* æ‰§è¡Œåˆ°è¿™é‡Œä¹‹å‰ï¼š
	* 1.lr_svc ä¿å­˜æœ‰è¢«ä¸­æ–­æ¨¡å¼ä¸‹çš„ä¸‹ä¸€æ¡å³å°†æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€
	* 2.SPSR_svc ä¿å­˜æœ‰è¢«ä¸­æ–­æ¨¡å¼çš„CPSR
	* 3.CPSRä¸­çš„M4-M0è¢«è®¾ç½®ä½10011b,è¿›å…¥åˆ°svcæ¨¡å¼
	* 4.è·³åˆ°0x8çš„åœ°æ–¹æ‰§è¡Œswiå‘é‡
	*/

	/* sp undæœªè®¾ç½®ï¼Œå…ˆè®¾ç½®å®ƒ */
	ldr sp, = 0x33e00000

	/*
	* lræ˜¯å¼‚å¸¸å¤„ç†å®Œåçš„è¿”å›åœ°å€ï¼Œä¹Ÿè¦ä¿å­˜
	*/
	stmdb sp!, {r0-r12, lr}	/* åœ¨undå¼‚å¸¸å¤„ç†å‡½æ•°ä¸­æœ‰å¯èƒ½ä¼šä¿®æ”¹r0-r12ï¼Œæ‰€ä»¥å…ˆä¿å­˜ä¸‹æ¥ */
	
	/* ä¿å­˜ç°åœº */	
	/* å¤„ç†swiå¼‚å¸¸ */
	mrs r0, cpsr
	ldr r1, = swi_string
	bl printException

	sub r0, r4, #4
	bl printSWIVal
	
	/* æ¢å¤ç°åœº */
	ldmia sp!, {r0-r12, pc}^	/*å°–æ‹¬å·ä¼šæŠŠspsrçš„å€¼æ¢å¤åˆ°cpsrä¸­*/ 
	
swi_string:
	.string "swi exception"

/* ä¿è¯åé¢çš„æŒ‡ä»¤æ˜¯4å­—èŠ‚å¯¹é½ */
.align 4

reset:
	/* ¹Ø±Õ¿´ÃÅ¹· */
	ldr r0, =0x53000000
	ldr r1, =0
	str r1, [r0]

	/* ÉèÖÃMPLL, FCLK : HCLK : PCLK = 400m : 100m : 50m */
	/* LOCKTIME(0x4C000000) = 0xFFFFFFFF */
	ldr r0, =0x4C000000
	ldr r1, =0xFFFFFFFF
	str r1, [r0]

	/* CLKDIVN(0x4C000014) = 0X5, tFCLK:tHCLK:tPCLK = 1:4:8  */
	ldr r0, =0x4C000014
	ldr r1, =0x5
	str r1, [r0]

	/* ÉèÖÃCPU¹¤×÷ÓÚÒì²½Ä£Ê½ */
	mrc p15,0,r0,c1,c0,0
	orr r0,r0,#0xc0000000   //R1_nF:OR:R1_iA
	mcr p15,0,r0,c1,c0,0

	/* ÉèÖÃMPLLCON(0x4C000004) = (92<<12)|(1<<4)|(1<<0) 
	 *  m = MDIV+8 = 92+8=100
	 *  p = PDIV+2 = 1+2 = 3
	 *  s = SDIV = 1
	 *  FCLK = 2*m*Fin/(p*2^s) = 2*100*12/(3*2^1)=400M
	 */
	ldr r0, =0x4C000004
	ldr r1, =(92<<12)|(1<<4)|(1<<0)
	str r1, [r0]

	/* Ò»µ©ÉèÖÃPLL, ¾Í»áËø¶¨lock timeÖ±µ½PLLÊä³öÎÈ¶¨
	 * È»ºóCPU¹¤×÷ÓÚĞÂµÄÆµÂÊFCLK
	 */
	
	
	/* ÉèÖÃÄÚ´æ: sp Õ» */
	/* ·Ö±æÊÇnor/nandÆô¶¯
	 * Ğ´0µ½0µØÖ·, ÔÙ¶Á³öÀ´
	 * Èç¹ûµÃµ½0, ±íÊ¾0µØÖ·ÉÏµÄÄÚÈİ±»ĞŞ¸ÄÁË, Ëü¶ÔÓ¦ram, Õâ¾ÍÊÇnandÆô¶¯
	 * ·ñÔò¾ÍÊÇnorÆô¶¯
	 */
	mov r1, #0
	ldr r0, [r1] /* ¶Á³öÔ­À´µÄÖµ±¸·İ */
	str r1, [r1] /* 0->[0] */ 
	ldr r2, [r1] /* r2=[0] */
	cmp r1, r2   /* r1==r2? Èç¹ûÏàµÈ±íÊ¾ÊÇNANDÆô¶¯ */
	ldr sp, =0x40000000+4096 /* ÏÈ¼ÙÉèÊÇnorÆô¶¯ */
	moveq sp, #4096  /* nandÆô¶¯ */
	streq r0, [r1]   /* »Ö¸´Ô­À´µÄÖµ */

	/*
	* åˆå§‹åŒ–sdram
	*/
	/* bl sdram_init1 */
	bl sdram_init2		/* ç”¨åˆ°äº†æœ‰åˆå§‹å€¼çš„rodataé‡Œé¢ï¼Œä¸èƒ½ä½¿ç”¨ä½ç½®æ— å…³ç  */

	/*
	* é‡å®šä½dataæ®µ,rodata,dataæ®µæ•´ä¸ªç¨‹åº
	*/
	bl copy2sdram

	/*
	* æ¸…é™¤bssæ®µ
	*/	
	bl clean_bss

	/* 
	* 1.å¤ä½ä¹‹åï¼Œcpuå¤„äºsvcæ¨¡å¼(ç®¡ç†æ¨¡å¼)
	* 2.ç°åœ¨ï¼Œåˆ‡æ¢åˆ°usræ¨¡å¼ï¼Œä¸»è¦æ˜¯è¿™ä¸ªç”¨æˆ·æ¨¡å¼
	*/
	mrs	r0, cpsr			/* è¯»å‡ºcpsr */
	bic r0, r0, #0xf		/* ä¿®æ”¹m4-m0ä¸º0b10000,è¿›å…¥usræ¨¡å¼ */
	bic r0, r0, #(1<<7)		/* æ¸…é™¤Iä½ï¼Œä½¿èƒ½ä¸­æ–­ */
	msr cpsr, r0			/* æŠŠå¯„å­˜å™¨çš„å€¼æ”¾å…¥cpsr ä¸­ */
	
	/* è®¾ç½®sp_usr(usræ¨¡å¼ä¸‹çš„æ ˆ) */
	ldr sp, =0x33f00000

	ldr pc, = sdram
sdram:
	bl uart0_init

	bl print1
	/* æ•…æ„åŠ å…¥ä¸€æ¡æœªå®šä¹‰æŒ‡ä»¤ */
und_code:
	.word 0x03000000		//0xdeadc0de,è¿™æ¡ä¹Ÿæ˜¯æœªå®šä¹‰æŒ‡ä»¤
	
	bl print2

	/* å¼•å…¥swiæŒ‡ä»¤ */
	swi 0x123	/* æ‰§è¡Œæ­¤å‘½ä»¤ï¼Œè§¦å‘SWIå¼‚å¸¸,è¿›å…¥0x8åœ°æ–¹æ‰§è¡Œ(å‘é‡åœ°å€æ˜¯0x8) */
	
	//bl main
	ldr pc, = main /* ç»å¯¹è·³è½¬ï¼Œè·³åˆ°SDRAM */

halt:
	b halt
	
